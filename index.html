<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>春节请假策略小工具（HTML 版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7fb;
      color: #222;
    }
    .container {
      max-width: 900px;
      margin: 32px auto;
      padding: 24px 20px 40px;
      background: #fff;
      box-shadow: 0 4px 18px rgba(15, 23, 42, 0.08);
      border-radius: 16px;
    }
    h1 {
      font-size: 26px;
      margin: 0 0 8px;
    }
    h2 {
      font-size: 20px;
      margin-top: 28px;
      margin-bottom: 8px;
      border-left: 4px solid #2563eb;
      padding-left: 8px;
    }
    p, li {
      line-height: 1.6;
    }
    .hint {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 12px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px 16px;
      margin-top: 8px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 14px;
    }
    label {
      font-weight: 500;
      color: #374151;
    }
    input[type="number"], input[type="text"] {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      width: 100%;
      box-sizing: border-box;
    }
    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.2);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 12px;
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.35);
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.08s;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4);
      background: #1d4ed8;
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.45);
    }
    .result-card {
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: 12px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1e3a8a;
      font-size: 14px;
    }
    .result-card strong {
      font-size: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    code {
      background: #f3f4f6;
      padding: 1px 4px;
      border-radius: 4px;
      font-size: 12px;
    }
    .footer {
      margin-top: 28px;
      font-size: 12px;
      color: #9ca3af;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>春节请假策略小工具（HTML 版）</h1>
    <p class="hint">
      根据同事最新的休假统计，结合你对
      <strong>“不太累”</strong> 和 <strong>“休假清净”</strong> 的偏好，
      自动给出春节前后 <strong>3 天年假</strong> 的最优放假方案。
    </p>

    <h2>1. 输入同事休假比例</h2>
    <p class="hint">
      每个日期填 <code>0~1</code> 的小数，或 <code>a/b</code>（如 <code>6/31</code>）。
      下方已预填你目前的统计数据，可直接修改。
    </p>

    <div class="grid" id="prob-grid"></div>

    <h2>2. 设置权重（偏好）</h2>
    <ul class="hint">
      <li><strong>α（疲劳权重）</strong>：越大越不想太累（更惩罚连续工作段很长）。</li>
      <li><strong>β（被打扰权重）</strong>：越大越不想休假被打扰（更惩罚在多数人上班的日子休假）。</li>
    </ul>

    <div class="grid">
      <div class="field">
        <label for="alpha">α：连续工作疲劳权重</label>
        <input id="alpha" type="number" step="0.1" min="0.1" max="10" value="1.0" />
      </div>
      <div class="field">
        <label for="beta">β：休假被打扰权重</label>
        <input id="beta" type="number" step="0.1" min="0.1" max="10" value="1.0" />
      </div>
    </div>

    <h2>3. 计算最优方案</h2>
    <button class="btn" id="calc-btn">计算 / 刷新推荐方案</button>

    <div id="result"></div>

    <div class="footer">
      纯前端版 · 可直接用浏览器打开此 HTML 文件使用
    </div>
  </div>

  <script>
    // 与 Python 版本保持一致的默认统计：day -> (a, b)
    const DEFAULT_COUNTS = {
      12: [6, 31],
      13: [18, 31],
      14: [26, 31],
      24: [18, 31],
      25: [14, 31],
      26: [1, 31]
    };

    const CANDIDATE_DAYS = [12, 13, 14, 24, 25, 26];

    function dayLabel(day) {
      return `2-${day.toString().padStart(2, "0")}`;
    }

    function defaultProb(day) {
      const v = DEFAULT_COUNTS[day];
      if (!v) return 0.0;
      return v[0] / v[1];
    }

    // 渲染概率输入区
    function renderProbGrid() {
      const grid = document.getElementById("prob-grid");
      grid.innerHTML = "";
      CANDIDATE_DAYS.forEach(day => {
        const div = document.createElement("div");
        div.className = "field";
        const label = document.createElement("label");
        label.textContent = `${dayLabel(day)} 休假比例`;
        const input = document.createElement("input");
        input.type = "text"; // 支持 0.48 和 6/31
        input.id = `p-${day}`;
        input.value = defaultProb(day).toFixed(4); // 预填 4 位小数
        div.appendChild(label);
        div.appendChild(input);
        grid.appendChild(div);
      });
    }

    // 解析 0.48 或 6/31
    function parseProbability(text) {
      const s = text.trim();
      if (!s) throw new Error("空输入");
      if (s.includes("/")) {
        const [a, b] = s.split("/", 2).map(x => parseFloat(x));
        if (!isFinite(a) || !isFinite(b) || b === 0) {
          throw new Error("比例格式错误");
        }
        return a / b;
      }
      const v = parseFloat(s);
      if (!isFinite(v)) throw new Error("小数格式错误");
      return v;
    }

    function getProbabilities() {
      const probs = {};
      for (const day of CANDIDATE_DAYS) {
        const el = document.getElementById(`p-${day}`);
        try {
          const v = parseProbability(el.value);
          if (v < 0 || v > 1) {
            alert(`${dayLabel(day)} 的比例必须在 0~1 之间`);
            throw new Error("out of range");
          }
          probs[day] = v;
        } catch (e) {
          alert(`${dayLabel(day)} 的输入有误，请填 0.48 或 6/31 这类格式`);
          throw e;
        }
      }
      return probs;
    }

    // 惩罚函数 w(n) = 1.3^(max(n-5, 0))
    function w(n) {
      return Math.pow(1.3, Math.max(n - 5, 0));
    }

    // 计算连续上班块长度
    function work(vacDays) {
      // 与 Python 版保持一致：
      // base_work_days = set(range(9, 15)) | set(range(25, 29))  # 9-14, 25-28
      const base = [];
      for (let d = 9; d <= 14; d++) base.push(d);
      for (let d = 25; d <= 28; d++) base.push(d);

      const vacSet = new Set(vacDays);
      const actual = base.filter(d => !vacSet.has(d)).sort((a, b) => a - b);
      if (actual.length === 0) return [];

      const blocks = [];
      let start = actual[0];
      let prev = start;
      for (let i = 1; i < actual.length; i++) {
        const day = actual[i];
        if (day === prev + 1) {
          prev = day;
        } else {
          blocks.push(prev - start + 1);
          start = prev = day;
        }
      }
      blocks.push(prev - start + 1);
      return blocks;
    }

    // 生成所有合法方案（与 Python generate_plans 一致）
    function generatePlans() {
      const preDays = [12, 13, 14];
      const postDays = [24, 25, 26];
      const totalVac = 3;
      const plans = [];
      for (let kPre = 0; kPre <= totalVac; kPre++) {
        const kPost = totalVac - kPre;
        if (kPre > preDays.length || kPost > postDays.length) continue;
        const prePart = kPre > 0 ? preDays.slice(preDays.length - kPre) : [];
        const postPart = kPost > 0 ? postDays.slice(0, kPost) : [];
        plans.push(prePart.concat(postPart));
      }
      return plans;
    }

    // 打分函数：score = 1 / (alpha * fatigue + beta * disturb)
    function score(plan, probs, alpha, beta) {
      const blocks = work(plan);
      const fatigue = blocks.reduce((acc, n) => acc + w(n), 0);
      const disturb = plan.reduce((acc, d) => acc + (1 - (probs[d] ?? 0)), 0);
      const totalCost = alpha * fatigue + beta * disturb;
      return {
        score: 1.0 / totalCost,
        fatigue,
        disturb
      };
    }

    function calculate() {
      let probs;
      try {
        probs = getProbabilities();
      } catch (e) {
        return;
      }

      const alphaInput = document.getElementById("alpha");
      const betaInput = document.getElementById("beta");
      const alpha = parseFloat(alphaInput.value) || 1.0;
      const beta = parseFloat(betaInput.value) || 1.0;
      if (alpha <= 0 || beta <= 0) {
        alert("α 和 β 必须为正数");
        return;
      }

      const plans = generatePlans();
      const rows = [];
      let bestPlan = null;
      let bestScore = null;

      for (const plan of plans) {
        const { score: sc, fatigue, disturb } = score(plan, probs, alpha, beta);
        rows.push({
          plan,
          score: sc,
          fatigue,
          disturb
        });
        if (bestScore === null || sc > bestScore) {
          bestScore = sc;
          bestPlan = plan;
        }
      }

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      if (!bestPlan) {
        const warn = document.createElement("div");
        warn.className = "result-card";
        warn.textContent = "当前没有生成任何合法方案，请检查逻辑。";
        resultDiv.appendChild(warn);
        return;
      }

      // 推荐卡片
      const card = document.createElement("div");
      card.className = "result-card";
      const bestStr = bestPlan.map(d => dayLabel(d)).join("、");
      card.innerHTML = `
        <strong>推荐最优 3 天年假：</strong> ${bestStr}<br/>
        综合得分（越高越好）：<strong>${bestScore.toFixed(6)}</strong>
      `;
      resultDiv.appendChild(card);

      // 表格
      const tableWrap = document.createElement("div");
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>方案</th>
          <th>Score</th>
          <th>疲劳成本</th>
          <th>被打扰成本</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      const sorted = rows.sort((a, b) => b.score - a.score);
      for (const row of sorted) {
        const tr = document.createElement("tr");
        const planStr = row.plan.map(d => dayLabel(d)).join("、");
        tr.innerHTML = `
          <td>${planStr}</td>
          <td>${row.score.toFixed(6)}</td>
          <td>${row.fatigue.toFixed(4)}</td>
          <td>${row.disturb.toFixed(4)}</td>
        `;
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      tableWrap.appendChild(table);
      resultDiv.appendChild(tableWrap);
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderProbGrid();
      document.getElementById("calc-btn").addEventListener("click", calculate);
    });
  </script>
</body>
</html>
